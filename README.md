# First-20191127
第一个仓库


CREATE TABLE ys_user_gwzd_191227(
serial_number VARCHAR2(40),
user_id NUMBER,
remove_tag VARCHAR2(10),
eparchy_code VARCHAR2(40),
eparchy_name VARCHAR2(100)
);

ALTER TABLE ys_user_gwzd_191227 ADD(REMARK VARCHAR2(400));

UPDATE ys_user_gwzd_191227 a
SET a.serial_number = TRIM(a.serial_number);


UPDATE YS_USER_GWZD_191227 A
   SET (a.yu,A.USER_ID, A.REMOVE_TAG, A.EPARCHY_CODE) =
       (SELECT 'CBSS',U.USER_ID, U.REMOVE_TAG, U.EPARCHY_CODE
          FROM UCR_CRM5.TF_F_USER U
         WHERE U.SERIAL_NUMBER = A.SERIAL_NUMBER
           AND U.PROVINCE_CODE = '76'
           AND U.REMOVE_TAG = '0');
COMMIT;

UPDATE YS_USER_GWZD_191227 A
   SET (a.yu,A.USER_ID, A.REMOVE_TAG, A.EPARCHY_CODE) =
       (SELECT 'BSS',U.USER_ID, U.REMOVE_TAG, U.EPARCHY_CODE
          FROM UCR_CRM1.TF_F_USER@TO_CRM1 U
         WHERE U.SERIAL_NUMBER = A.SERIAL_NUMBER
           AND U.REMOVE_TAG = '0'
        UNION ALL
        SELECT 'BSS',U.USER_ID, U.REMOVE_TAG, U.EPARCHY_CODE
          FROM UCR_CRM2.TF_F_USER@TO_CRM1 U
         WHERE U.SERIAL_NUMBER = A.SERIAL_NUMBER
           AND U.REMOVE_TAG = '0'
        UNION ALL
        SELECT 'BSS',U.USER_ID, U.REMOVE_TAG, U.EPARCHY_CODE
          FROM UCR_CRM3.TF_F_USER@TO_CRM2 U
         WHERE U.SERIAL_NUMBER = A.SERIAL_NUMBER
           AND U.REMOVE_TAG = '0'
        UNION ALL
        SELECT 'BSS',U.USER_ID, U.REMOVE_TAG, U.EPARCHY_CODE
          FROM UCR_CRM4.TF_F_USER@TO_CRM2 U
         WHERE U.SERIAL_NUMBER = A.SERIAL_NUMBER
           AND U.REMOVE_TAG = '0'
           )
 WHERE A.USER_ID IS NULL;
COMMIT;

--CBSS
UPDATE YS_USER_GWZD_191227 A
   SET (a.yu,A.USER_ID, A.REMOVE_TAG, A.EPARCHY_CODE) =
       (SELECT 'CBSS',U.USER_ID, U.REMOVE_TAG, U.EPARCHY_CODE
          FROM UCR_CRM5.TF_F_USER U
         WHERE U.SERIAL_NUMBER = A.SERIAL_NUMBER
           AND U.PROVINCE_CODE = '76'
           AND U.DESTROY_TIME =
               (SELECT MAX(B.DESTROY_TIME)
                  FROM UCR_CRM5.TF_F_USER B
                 WHERE B.SERIAL_NUMBER = A.SERIAL_NUMBER))
 WHERE A.USER_ID IS NULL;
COMMIT;
--BSS

UPDATE YS_USER_GWZD_191227 A
   SET (a.yu,A.USER_ID, A.REMOVE_TAG, A.EPARCHY_CODE) =
       (SELECT 'CBSS',U.USER_ID, U.REMOVE_TAG, U.EPARCHY_CODE
          FROM UCR_CRM1.TF_F_USER@TO_CRM1 U
         WHERE U.SERIAL_NUMBER = A.SERIAL_NUMBER
           AND U.PROVINCE_CODE = '76'
           AND U.DESTROY_TIME =
               (SELECT MAX(B.DESTROY_TIME)
                  FROM UCR_CRM1.TF_F_USER@TO_CRM1 B
                 WHERE B.SERIAL_NUMBER = A.SERIAL_NUMBER))
 WHERE A.USER_ID IS NULL;
COMMIT;

UPDATE YS_USER_GWZD_191227 A
   SET (a.yu,A.USER_ID, A.REMOVE_TAG, A.EPARCHY_CODE) =
       (SELECT 'CBSS',U.USER_ID, U.REMOVE_TAG, U.EPARCHY_CODE
          FROM UCR_CRM2.TF_F_USER@TO_CRM1 U
         WHERE U.SERIAL_NUMBER = A.SERIAL_NUMBER
           AND U.PROVINCE_CODE = '76'
           AND U.DESTROY_TIME =
               (SELECT MAX(B.DESTROY_TIME)
                  FROM UCR_CRM2.TF_F_USER@TO_CRM1 B
                 WHERE B.SERIAL_NUMBER = A.SERIAL_NUMBER))
 WHERE A.USER_ID IS NULL;
COMMIT;


UPDATE YS_USER_GWZD_191227 A
   SET (a.yu,A.USER_ID, A.REMOVE_TAG, A.EPARCHY_CODE) =
       (SELECT 'CBSS',U.USER_ID, U.REMOVE_TAG, U.EPARCHY_CODE
          FROM UCR_CRM3.TF_F_USER@TO_CRM2 U
         WHERE U.SERIAL_NUMBER = A.SERIAL_NUMBER
           AND U.PROVINCE_CODE = '76'
           AND U.DESTROY_TIME =
               (SELECT MAX(B.DESTROY_TIME)
                  FROM UCR_CRM3.TF_F_USER@TO_CRM2 B
                 WHERE B.SERIAL_NUMBER = A.SERIAL_NUMBER))
 WHERE A.USER_ID IS NULL;
COMMIT;


UPDATE YS_USER_GWZD_191227 A
   SET (a.yu,A.USER_ID, A.REMOVE_TAG, A.EPARCHY_CODE) =
       (SELECT 'CBSS',U.USER_ID, U.REMOVE_TAG, U.EPARCHY_CODE
          FROM UCR_CRM4.TF_F_USER@TO_CRM2 U
         WHERE U.SERIAL_NUMBER = A.SERIAL_NUMBER
           AND U.PROVINCE_CODE = '76'
           AND U.DESTROY_TIME =
               (SELECT MAX(B.DESTROY_TIME)
                  FROM UCR_CRM4.TF_F_USER@TO_CRM2 B
                 WHERE B.SERIAL_NUMBER = A.SERIAL_NUMBER))
 WHERE A.USER_ID IS NULL;
COMMIT;


UPDATE YS_USER_GWZD_191227 A
   SET A.REMARK = 'B侧和CB都没有该用户'
 WHERE A.USER_ID IS NULL;
COMMIT;

ALTER TABLE YS_USER_GWZD_191227 ADD(trade_id NUMBER,accept_date DATE,product_id NUMBER,product_name VARCHAR2(400),
device_name VARCHAR2(400),product_id_50 NUMBER,product_name_50 VARCHAR2(400));

UPDATE YS_USER_GWZD_191227 A
   SET (A.TRADE_ID,
        A.ACCEPT_DATE,
        A.PRODUCT_ID,
        A.DEVICE_NAME,
        A.PRODUCT_ID_50) =
       (SELECT T.TRADE_ID,
               T.ACCEPT_DATE,
               T.PRODUCT_ID,
               P.DEVICE_NAME,
               P.PRODUCT_ID
          FROM UCR_CRM5.TF_BH_TRADE T, UCR_CRM5.TF_B_TRADE_PURCHASE P
         WHERE P.USER_ID = A.USER_ID
           AND P.ACCEPT_MONTH IN ('11', '12')
           AND P.TRADE_ID = T.TRADE_ID
           AND P.ACCEPT_MONTH = T.ACCEPT_MONTH
           AND T.ACCEPT_DATE BETWEEN TO_DATE('20191101', 'yyyy/mm/dd') AND
               TO_DATE('20191231235959', 'yyyy/mm/dd hh24:mi:ss')
           AND T.PROVINCE_CODE = '76'
           AND T.SUBSCRIBE_STATE = '9'
           AND T.NEXT_DEAL_TAG = '0'
           AND T.CANCEL_TAG = '0'
           AND ROWNUM = 1)
 WHERE A.USER_ID IS NOT NULL
 AND a.remark IS NULL;
COMMIT;



UPDATE YS_USER_GWZD_191227 A
   SET A.PRODUCT_NAME   =
       (SELECT P.PRODUCT_NAME
          FROM UCR_CEN1.TD_B_PRODUCT P
         WHERE P.PRODUCT_ID = A.PRODUCT_ID),
       A.PRODUCT_NAME_50 =
       (SELECT P.PRODUCT_NAME
          FROM UCR_CEN1.TD_B_PRODUCT P
         WHERE P.PRODUCT_ID = A.PRODUCT_ID_50)
 WHERE A.PRODUCT_ID IS NOT NULL;

SELECT a.* FROM ucr_Crm5.Tf_b_Trade_Purchase a WHERE a.user_id = '7617112931704926';



SELECT * from ucr_Crm5.Tf_Bh_Trade a WHERE a.trade_id IN ('7617112912100154','7619122427255801');


SELECT * from ys_user_gwzd_191227 a WHERE a.remark IS NULL;


SELECT * from ys_user_gwzd_191227 a WHERE a.serial_number = '16639395166';


UPDATE YS_USER_GWZD_191227 A
   SET A.REMARK = '未受理的终端合约'
 WHERE A.TRADE_ID IS NULL
   AND A.USER_ID IS NOT NULL;


UPDATE YS_USER_GWZD_191227 A
   SET A.REMARK = '11、12月份受理的终端合约'
 WHERE A.TRADE_ID IS NOT NULL
   AND A.REMARK IS NULL;



ALTER TABLE YS_USER_GWZD_191227 ADD(yu VARCHAR2(40));

UPDATE YS_USER_GWZD_191227 A
   SET A.EPARCHY_NAME =
       (SELECT WC.CITY_NAME
          FROM WXL_CITY WC
         WHERE A.EPARCHY_CODE = WC.CITY_ID);

SELECT A.REMARK, COUNT(1) FROM YS_USER_GWZD_191227 A GROUP BY A.REMARK;

SELECT A.YU,
       A.EPARCHY_CODE,
       A.EPARCHY_NAME,
       A.SERIAL_NUMBER,
       A.USER_ID,
       A.REMOVE_TAG,
       A.TRADE_ID        工单ID,
       A.DEVICE_NAME,
       A.ACCEPT_DATE     受理时间,
       A.PRODUCT_ID      主套餐ID,
       A.PRODUCT_NAME    主套餐名称,
       A.PRODUCT_ID_50   活动ID,
       A.PRODUCT_NAME_50 活动名称,
       A.REMARK          备注
  FROM YS_USER_GWZD_191227 A
 WHERE A.REMARK = '';
